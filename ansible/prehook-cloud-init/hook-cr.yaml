---
# MTV Hook CR for installing cloud-init before migration
#
# Apply this to your cluster:
#   kubectl apply -f hook-cr.yaml
#
# Then reference it in your migration Plan:
#   spec:
#     vms:
#       - id: vm-123
#         hooks:
#           - hook:
#               namespace: konveyor-forklift
#               name: install-cloud-init
#             step: PreHook
#
apiVersion: forklift.konveyor.io/v1beta1
kind: Hook
metadata:
  name: install-cloud-init
  namespace: konveyor-forklift
spec:
  # The hook-runner image contains Ansible and kubectl
  image: quay.io/konveyor/hook-runner:latest
  
  # Base64 encoded playbook (see playbook.yml)
  # To regenerate: ../scripts/encode-playbook.sh playbook.yml
  playbook: LS0tCiMgUHJlSG9vazogSW5zdGFsbCBjbG91ZC1pbml0IG9uIHRoZSBWTSBiZWZvcmUgbWlncmF0aW9uCiMgVGhpcyBwcmVwYXJlcyB0aGUgVk0gZm9yIGNsb3VkLW5hdGl2ZSBvcGVyYXRpb25zIGluIE9wZW5TaGlmdCBWaXJ0dWFsaXphdGlvbgoKLSBuYW1lOiBQcmVIb29rIC0gU2V0dXAgU1NIIGFuZCBsb2FkIE1UViBtZXRhZGF0YQogIGhvc3RzOiBsb2NhbGhvc3QKICBnYXRoZXJfZmFjdHM6IHllcwogIHRhc2tzOgogICAgLSBuYW1lOiBMb2FkIG1pZ3JhdGlvbiBQbGFuIG1ldGFkYXRhCiAgICAgIGluY2x1ZGVfdmFyczoKICAgICAgICBmaWxlOiBwbGFuLnltbAogICAgICAgIG5hbWU6IHBsYW4KCiAgICAtIG5hbWU6IExvYWQgVk0gd29ya2xvYWQgbWV0YWRhdGEKICAgICAgaW5jbHVkZV92YXJzOgogICAgICAgIGZpbGU6IHdvcmtsb2FkLnltbAogICAgICAgIG5hbWU6IHdvcmtsb2FkCgogICAgLSBuYW1lOiBHZXQgY3VycmVudCB1c2VyIGluZm8gZm9yIFNTSCBzZXR1cAogICAgICBnZXRlbnQ6CiAgICAgICAgZGF0YWJhc2U6IHBhc3N3ZAogICAgICAgIGtleTogInt7IGFuc2libGVfdXNlcl9pZCB9fSIKICAgICAgICBzcGxpdDogJzonCgogICAgLSBuYW1lOiBFbnN1cmUgU1NIIGRpcmVjdG9yeSBleGlzdHMKICAgICAgZmlsZToKICAgICAgICBwYXRoOiB+Ly5zc2gKICAgICAgICBzdGF0ZTogZGlyZWN0b3J5CiAgICAgICAgbW9kZTogMDc1MAogICAgICBlbnZpcm9ubWVudDoKICAgICAgICBIT01FOiAie3sgYW5zaWJsZV9mYWN0cy5nZXRlbnRfcGFzc3dkW2Fuc2libGVfdXNlcl9pZF1bNF0gfX0iCgogICAgLSBuYW1lOiBSZXRyaWV2ZSBTU0ggY3JlZGVudGlhbHMgZnJvbSBLdWJlcm5ldGVzIFNlY3JldAogICAgICBrOHNfaW5mbzoKICAgICAgICBhcGlfdmVyc2lvbjogdjEKICAgICAgICBraW5kOiBTZWNyZXQKICAgICAgICBuYW1lOiB2bS1zc2gtY3JlZGVudGlhbHMKICAgICAgICBuYW1lc3BhY2U6IGtvbnZleW9yLWZvcmtsaWZ0CiAgICAgIHJlZ2lzdGVyOiBzc2hfY3JlZGVudGlhbHMKCiAgICAtIG5hbWU6IENyZWF0ZSBTU0ggcHJpdmF0ZSBrZXkgZmlsZQogICAgICBjb3B5OgogICAgICAgIGRlc3Q6IH4vLnNzaC9tdHZfbWlncmF0aW9uX2tleQogICAgICAgIGNvbnRlbnQ6ICJ7eyBzc2hfY3JlZGVudGlhbHMucmVzb3VyY2VzWzBdLmRhdGEua2V5IHwgYjY0ZGVjb2RlIH19IgogICAgICAgIG1vZGU6IDA2MDAKCiAgICAtIG5hbWU6IEFkZCB0YXJnZXQgVk0gdG8gQW5zaWJsZSBpbnZlbnRvcnkKICAgICAgYWRkX2hvc3Q6CiAgICAgICAgbmFtZTogInt7IHdvcmtsb2FkLnZtLmlwYWRkcmVzcyB9fSIKICAgICAgICBhbnNpYmxlX3VzZXI6IHJvb3QKICAgICAgICBhbnNpYmxlX3NzaF9wcml2YXRlX2tleV9maWxlOiB+Ly5zc2gvbXR2X21pZ3JhdGlvbl9rZXkKICAgICAgICBhbnNpYmxlX3NzaF9jb21tb25fYXJnczogJy1vIFN0cmljdEhvc3RLZXlDaGVja2luZz1ubycKICAgICAgICBncm91cHM6IHRhcmdldF92bXMKCi0gbmFtZTogSW5zdGFsbCBjbG91ZC1pbml0IG9uIHRhcmdldCBWTQogIGhvc3RzOiB0YXJnZXRfdm1zCiAgZ2F0aGVyX2ZhY3RzOiB5ZXMKICB0YXNrczoKICAgIC0gbmFtZTogSW5zdGFsbCBjbG91ZC1pbml0IHBhY2thZ2UgKFJIRUwvQ2VudE9TKQogICAgICBkbmY6CiAgICAgICAgbmFtZToKICAgICAgICAgIC0gY2xvdWQtaW5pdAogICAgICAgIHN0YXRlOiBwcmVzZW50CiAgICAgIHdoZW46IGFuc2libGVfb3NfZmFtaWx5ID09ICJSZWRIYXQiCgogICAgLSBuYW1lOiBJbnN0YWxsIGNsb3VkLWluaXQgcGFja2FnZSAoRGViaWFuL1VidW50dSkKICAgICAgYXB0OgogICAgICAgIG5hbWU6CiAgICAgICAgICAtIGNsb3VkLWluaXQKICAgICAgICBzdGF0ZTogcHJlc2VudAogICAgICAgIHVwZGF0ZV9jYWNoZTogeWVzCiAgICAgIHdoZW46IGFuc2libGVfb3NfZmFtaWx5ID09ICJEZWJpYW4iCgogICAgLSBuYW1lOiBFbmFibGUgY2xvdWQtaW5pdCBzZXJ2aWNlcwogICAgICBzeXN0ZW1kOgogICAgICAgIG5hbWU6ICJ7eyBpdGVtIH19IgogICAgICAgIGVuYWJsZWQ6IHllcwogICAgICBsb29wOgogICAgICAgIC0gY2xvdWQtaW5pdC1sb2NhbAogICAgICAgIC0gY2xvdWQtaW5pdAogICAgICAgIC0gY2xvdWQtY29uZmlnCiAgICAgICAgLSBjbG91ZC1maW5hbAogICAgICBpZ25vcmVfZXJyb3JzOiB5ZXMKCiAgICAtIG5hbWU6IENyZWF0ZSBjbG91ZC1pbml0IGNvbmZpZyBkaXJlY3RvcnkKICAgICAgZmlsZToKICAgICAgICBwYXRoOiAvZXRjL2Nsb3VkL2Nsb3VkLmNmZy5kCiAgICAgICAgc3RhdGU6IGRpcmVjdG9yeQogICAgICAgIG1vZGU6IDA3NTUKCiAgICAtIG5hbWU6IENvbmZpZ3VyZSBjbG91ZC1pbml0IGRhdGFzb3VyY2UgZm9yIE9wZW5TaGlmdAogICAgICBjb3B5OgogICAgICAgIGRlc3Q6IC9ldGMvY2xvdWQvY2xvdWQuY2ZnLmQvOTktb3BlbnNoaWZ0LmNmZwogICAgICAgIGNvbnRlbnQ6IHwKICAgICAgICAgICMgT3BlblNoaWZ0IFZpcnR1YWxpemF0aW9uIGRhdGFzb3VyY2UgY29uZmlndXJhdGlvbgogICAgICAgICAgZGF0YXNvdXJjZV9saXN0OiBbIE5vQ2xvdWQsIENvbmZpZ0RyaXZlLCBOb25lIF0KICAgICAgICAgIGRhdGFzb3VyY2U6CiAgICAgICAgICAgIE5vQ2xvdWQ6CiAgICAgICAgICAgICAgZnNfbGFiZWw6IGNpZGF0YQogICAgICAgIG1vZGU6IDA2NDQKCiAgICAtIG5hbWU6IExvZyBjb21wbGV0aW9uCiAgICAgIGRlYnVnOgogICAgICAgIG1zZzogImNsb3VkLWluaXQgaW5zdGFsbGF0aW9uIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkgb24ge3sgaW52ZW50b3J5X2hvc3RuYW1lIH19Igo=
  
  # ServiceAccount with permissions to read secrets
  serviceAccount: forklift-controller
  
  # Hook timeout in seconds (default: 600)
  deadline: 1800

