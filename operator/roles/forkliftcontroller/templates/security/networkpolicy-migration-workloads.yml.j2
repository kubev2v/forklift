# Network policies for virt-v2v conversion workloads
# Applies to virt-v2v pods used by VMware and OVA migrations for guest conversion
#
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-virt-v2v-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      forklift.app: virt-v2v
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow external provider access (vSphere + OVA)
  - ports:
    - protocol: TCP
      port: 80    # HTTP (Certificate validation, CRL, package repos)
    - protocol: TCP
      port: 443   # HTTPS (vSphere API + OVA downloads)
    - protocol: TCP
      port: 8443  # vSphere API HTTPS Development
    - protocol: TCP
      port: 902   # vSphere NFC storage transfer
    # Optional: allow TCP 8080 only if OVA/image sources are served over HTTP on nonstandard ports
    - protocol: TCP
      port: 8080  
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-ova-server-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      provider: ova-provider
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow OVA file access from virt-v2v pods
  - from:
    - podSelector:
        matchLabels:
          forklift.app: virt-v2v
    ports:
    - protocol: TCP
      port: 8080  # OVA server HTTP port
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # OVA server serves files from NFS storage, no external HTTP/HTTPS needed
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-hyperv-server-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      subapp: hyperv-server
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow inventory access from virt-v2v pods
  - from:
    - podSelector:
        matchLabels:
          forklift.app: virt-v2v
    ports:
    - protocol: TCP
      port: 8080  # HyperV server HTTP API port
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow WinRM access to external HyperV/Windows server
  - ports:
    - protocol: TCP
      port: 5986  # WinRM HTTPS
  # Allow SMB access to external HyperV/Windows server
  - ports:
    - protocol: TCP
      port: 445   # SMB over TCP
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---      
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-ovirt-populator-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      populator: ovirt
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow monitoring access to metrics
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-monitoring
    ports:
    - protocol: TCP
      port: 8080  # oVirt populator metrics
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow oVirt API and imageio access
  - ports:
    - protocol: TCP
      port: 443     # oVirt Engine API + modern proxy transfers
    - protocol: TCP
      port: 54323   # oVirt imageio-daemon (direct streaming from hosts)
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-openstack-populator-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      populator: openstack
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow monitoring access to metrics
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-monitoring
    ports:
    - protocol: TCP
      port: 8081  # OpenStack populator metrics
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow all egress - OpenStack uses dynamic service discovery with unpredictable ports
  # OpenStack deployments can use custom ports for any service (Keystone, Nova, Cinder, Neutron, etc.)
  # Attempting to list all possible ports would be incomplete and cause migration failures
  - {}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-vsphere-xcopy-populator-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      populator: vsphere-xcopy
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow monitoring access to metrics
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: openshift-monitoring
    ports:
    - protocol: TCP
      port: 8082  # vSphere Xcopy populator metrics
  egress:
  # Allow communication with controller
  - to:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
  # Allow vSphere API and NFC access
  - ports:
    - protocol: TCP
      port: 443   # vSphere API
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
# Image Converter Policy
# 
# The image converter is used during OpenStack migrations (PhaseConvertOpenstackSnapshot)
# to convert disk formats to RAW format required by KubeVirt. It performs local disk
# format conversion using qemu-img on locally mounted PVCs without requiring external
# network access.
#
# This policy is required when:
# - OpenStack migrations are performed
# - Source disks are in non-RAW formats (qcow2, vmdk, etc.)
# - Disk format conversion is needed before VM creation
#
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-image-converter-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      forklift.app: image-converter
  policyTypes:
  - Ingress
  ingress:
  # Allow controller communication
  - from:
    - podSelector:
        matchLabels:
          control-plane: controller-manager
    ports: []  # All ports allowed
