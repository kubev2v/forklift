---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forklift-api-policy
  namespace: {{ app_namespace }}
  labels:
    app: {{ app_name }}
spec:
  podSelector:
    matchLabels:
      service: {{ api_service_name }}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow 8443 from anywhere:
    # Required for admission webhooks. Flow: user -> k8s API server -> webhook -> k8s API server -> user
    # The API server calls the webhook, but API server traffic does not originate from a Pod/Namespace
    # that NetworkPolicy can match (API server runs on control plane nodes). Without this open ingress
    # rule, admission webhooks (e.g. Forklift API validation) would be blocked.
    - ports:
      - protocol: TCP
        port: 8443
    # Allow ValidatingAdmissionWebhook and MutatingAdmissionWebhook access via service port 443
    - ports:
      - protocol: TCP
        port: 443
    # Allow internal cluster access to services endpoint (port 8444)
    # UI plugin needs this for certificate retrieval service
    - from:
      - namespaceSelector: {}
      ports:
      - protocol: TCP
        port: 8444
  egress:
    # Allow all egress - API pod needs to reach external OCP clusters for validation
    # and certificate retrieval from arbitrary endpoints
    - {}